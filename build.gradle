/*
 * This build file was generated by the Gradle 'init' task.
 *
 * This generated file contains a commented-out sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/3.5/userguide/tutorial_java_projects.html
 */
plugins {
  id "com.mkobit.jenkins.pipelines.shared-library" version "0.10.1"
  id "jacoco"
  id "java"
  id "groovy"

}

// In this section you declare where to find the dependencies of your project
repositories {
  // Use 'jcenter' for resolving your dependencies.
  // You can declare any Maven/Ivy/file repository here.
  //All sub-projects will now refer to the same 'libs' directory
  maven { url 'http://bits.netbeans.org/maven2/' }
  maven { url 'https://repo.jenkins-ci.org/releases/' }
  jcenter()
  maven { url 'https://mvnrepository.com/artifact/' }
  mavenLocal()
  flatDir {
    dirs "jars"
  }
}

dependencies {
  testImplementation(group: 'junit', name: 'junit', version: '4.12')

  compile group: 'junit', name: 'junit', version: '4.12'
  compile group: 'org.assertj',           name: 'assertj-core',   version: '3.4.1'

  // Jenkis Pipeline JUnit
  compile group: 'com.lesfurets', name:'jenkins-pipeline-unit', version: '1.4'
  compile group: 'com.cloudbees', name: 'groovy-cps',           version: '1.34'

  // grapes
  compile       group: 'org.codehaus.groovy',    name: 'groovy-json',    version: '3.0.0-alpha-3'
  compile       group: 'com.github.zafarkhaja',  name: 'java-semver',    version: '0.9.0'
  compile       group: 'org.apache.commons',     name: 'commons-math3',  version: '3.4.1'

  // integration tests dependecies
  integrationTestCompile group: 'org.jvnet.mock-javamail',name: 'mock-javamail',  version: '1.9'
  integrationTestCompile group: 'org.slf4j', name: 'slf4j-nop', version: '1.7.30'
}

// In this section you declare the dependencies for your production and test code
compileGroovy {
  // Create temp file.
  File temp = File.createTempFile("config", ".groovy");

  // Delete temp file when program exits.
  temp.deleteOnExit();

  // Write to temp file
  BufferedWriter out = new BufferedWriter(new FileWriter(temp));
  out.write("""\
        withConfig(configuration) {
            configuration.setDisabledGlobalASTTransformations(['groovy.grape.GrabAnnotationTransformation'] as Set)
        }
    """.stripIndent());
  out.close();
  groovyOptions.configurationScript = temp
}

sourceSets {
  jobs {
    groovy {
      srcDirs 'jobs'
      compileClasspath += main.compileClasspath
    }
    compileClasspath += sourceSets.main.output
    runtimeClasspath += sourceSets.main.output
  }
}

sharedLibrary {
  coreVersion = "2.176.2"
  testHarnessVersion = "2.54"
  pluginDependencies {
    workflowCpsGlobalLibraryPluginVersion = "2.16"
    dependency("org.jenkins-ci.plugins", "pipeline-input-step", "2.8")
    dependency("org.jenkins-ci.plugins", "email-ext", "2.63")
  }
}

test {
  testLogging {
    events "PASSED", "FAILED", "SKIPPED"
  }
}

integrationTest {
  systemProperties 'java.net.preferIPv4Stack' : true
  testLogging {
    events "PASSED", "FAILED", "SKIPPED"
  }
}
